# Описание проекта

Данный проект предполагает настройку двух виртуальных машин с использованием Vagrant. Эти машины будут настроены для минимального использования ресурсов и обеспечат возможность безопасного SSH-подключения без пароля. На первой виртуальной машине будет развернут k3s server, мастер нода, с помощью которой k3s управляется. На второй машине будет развернута агент нода, привязанная к мастер ноде. Подробнее по установке k3s (server/agent) можно ознакомиться на сайте [K3S](https://docs.k3s.io/installation/configuration)

## Требования к настройке

### Общие требования

- Необходимо создать первый Vagrantfile.
- Используйте последнюю стабильную версию выбранного дистрибутива операционной системы.
- Рекомендуется выделить минимальные ресурсы для виртуальных машин:
  - 1 CPU
  - 1024 MB оперативной памяти
- Запуск виртуальных машин должен осуществляться через Vagrant.

### Спецификации машин

1. **Первая машина (nicknameS)**

   - Будет иметь выделенный IP-адрес на интерфейсе `eth1`: **192.168.56.110**.
   - Будет иметь мастер ноду k3s

2. **Вторая машина (nicknameSW)**

   - Будет иметь выделенный IP-адрес на интерфейсе `eth1`: **192.168.56.111**.
   - Будет иметь агент ноду k3s

## Инструкции по запуску

Запустите вирутальную машину. В виртуальной машине в настройках установите:

**Settings - System - Processor (Enable Nested VT-x/AMD-V is active)**

1. Установите [Vagrant](https://www.vagrantup.com/downloads) и [VirtualBox](https://www.virtualbox.org/).
2. Создайте файл `Vagrantfile` и сконфигурируйте его для обеих машин согласно описанным выше спецификациям.
3. Запустите машины командой:
   ```bash
   vagrant up
   ```
4. Подключитесь к машинам по SSH с помощью команд:
   ```bash
   vagrant ssh nicknameS
   vagrant ssh nicknameSW
   ```
5. Проверить статус запущенных машин
   ```bash
   vagrant status
   ```

## Подключение к nicknameS

1. После подключения по ssh к nicknameS проверить развернулся ли k3s server и k3s agent на вирутальных машинах:
   ```bash
   sudo kubectl get nodes -A
   ```
   
   Output:
   ```bash
   vagrant@vchizhovS:~$ sudo kubectl get nodes -A
   NAME         STATUS     ROLES                  AGE     VERSION
   vchizhovs    Ready      control-plane,master   6m41s   v1.31.5+k3s1
   vchizhovsw   Ready      <none>                 4m58s   v1.31.5+k3s1
   ```
   Если попробовать посмотреть статусы нод с агента будет выходить ошибка, связанная с тем, что агент не знает    по какому адресу обращаться к API k3s.

3. Чтобы получить информацию о кластере с агента, нужно настроить kubectl на второй машине так, чтобы он обращался к     API-серверу на первой машине:

   **Скопируйте kubeconfig файл с первой машины на вторую**

   На первой машине (192.168.56.110), файл kubeconfig обычно находится по пути /etc/rancher/k3s/k3s.yaml. Скопируйте     его на вторую машину:
   ```bash
   scp -P 2222 /etc/rancher/k3s/k3s.yaml vagrant\@127.0.0.1:/home/vagrant/k3s.yaml
   ```

   **Измените адрес API-сервера в скопированном kubeconfig**
   1. На второй машине (192.168.56.111), откройте файл k3s.yaml:
   2. Найдите строку server: [https://127.0.0.1:6443](https://127.0.0.1:6443) и замените 127.0.0.1 на IP-адрес вашего    сервера (192.168.56.110)
   
   **Настройте kubectl использовать этот файл**
   1. Укажите kubectl использовать обновленный kubeconfig файл:
   ```bash
   export KUBECONFIG=/home/vagrant/k3s.yaml
   ```
  
   **Постоянная настройка KUBECONFIG:**
   Чтобы не задавать KUBECONFIG каждый раз, добавьте экспорт в \~/.bashrc:

   ```bash
   echo "export KUBECONFIG=/home/vagrant/k3s.yaml" >> \~/.bashrc
   ```
   ```bash
   source \~/.bashrc
   ```
## Завершение работы

- Остановите виртуальные машины командой:
  ```bash
  vagrant halt
  ```
- Удалите виртуальные машины командой:
  ```bash
  vagrant destroy -f
  ```


